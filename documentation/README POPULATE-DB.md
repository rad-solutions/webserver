# README: `populate_db` Management Command & Manual SQL Inspection

This document provides information about the `populate_db` Django management command and includes SQL queries for manually inspecting the generated data in a PostgreSQL admin tool like pgAdmin.

## `populate_db` Django Management Command

The `populate_db` command is designed to fill the database with synthetic (fake) data for development and testing purposes. It uses the Faker library to generate realistic-looking information for various models in the application.

**Key Features:**

*   **Clears Existing Data:** Before populating, the script attempts to clear existing data from relevant tables. It specifically excludes superusers and a predefined list of test users (e.g., `cliente_test`, `gerente_test`, etc., which are typically created by the `app/scripts/create_users.py` script) to avoid conflicts.
*   **Creates Core Entities:**
    *   `Role`: Populates all roles defined in `RoleChoices`.
    *   `User`: Creates a mix of client users and internal staff users with randomly assigned internal roles.
    *   `ClientProfile`: Generates profiles for each client user.
*   **Creates Related Data:**
    *   `Process`: Creates multiple processes for each user.
    *   `Equipment`: Generates equipment records, typically associated with client users.
    *   `Report`: Creates reports linked to processes, including dummy PDF files. Reports may also be optionally associated with an `Equipment` instance.
    *   `Anotacion`: Populates annotations (notes) for processes, with some annotations being system-generated (no specific user) and others linked to the process owner or internal staff.
*   **Uses Colombian Locale:** Faker is configured with `'es_CO'` locale for more contextually relevant data (e.g., names, addresses).
*   **Transactional:** All database operations are wrapped in a transaction to ensure data integrity. If any part fails, the entire operation is rolled back.

**How to Run:**

The command can be executed using the `Makefile` target:

```bash
make populate-db
```

This typically runs:

```bash
docker compose exec web poetry run python manage.py populate_db
```

## Manual SQL Inspection Queries (for pgAdmin or similar tools)

The following SQL queries can be used to manually inspect the data generated by the `populate_db` script. These assume the default Django table naming convention (e.g., `app_modelname`).

1.  **Show a few users and their roles:**
    ```sql
    SELECT u.username, u.email, r.name AS role_name
    FROM app_user u
    JOIN app_user_roles ur ON u.id = ur.user_id
    JOIN app_role r ON ur.role_id = r.id
    LIMIT 10;
    ```

2.  **Show client profiles:**
    ```sql
    SELECT u.username, cp.razon_social, cp.nit, cp.departamento, cp.municipio
    FROM app_clientprofile cp
    JOIN app_user u ON cp.user_id = u.id
    LIMIT 5;
    ```

3.  **Show some processes and the user they belong to:**
    ```sql
    SELECT p.id AS process_id, p.process_type, p.estado, u.username AS owner_username
    FROM app_process p
    JOIN app_user u ON p.user_id = u.id
    LIMIT 10;
    ```

4.  **Show some equipment and their client owner:**
    ```sql
    SELECT e.nombre AS equipment_name, e.marca, e.modelo, e.serial, u.username AS client_owner
    FROM app_equipment e
    JOIN app_user u ON e.user_id = u.id
    LIMIT 5;
    ```

5.  **Show some reports, their process, associated equipment (if any), and the user who created the report:**
    ```sql
    SELECT
        r.id AS report_id,
        r.title,
        r.estado_reporte,
        p.id AS process_id,
        eq.nombre AS equipment_name, -- Added equipment name
        u.username AS report_creator
    FROM app_report r
    JOIN app_process p ON r.process_id = p.id
    JOIN app_user u ON r.user_id = u.id
    LEFT JOIN app_equipment eq ON r.equipment_id = eq.id -- Join for equipment
    LIMIT 10; -- Increased limit to see more variety
    ```

6.  **Show some annotations, their process, and the annotating user (if any):**
    ```sql
    SELECT a.id AS anotacion_id, a.contenido, a.fecha_creacion, p.id AS process_id, u.username AS annotator_username
    FROM app_anotacion a
    JOIN app_process p ON a.proceso_id = p.id
    LEFT JOIN app_user u ON a.usuario_id = u.id
    ORDER BY a.fecha_creacion DESC
    LIMIT 10;
    ```

7.  **Count records in main tables:**
    This query provides a quick overview of the number of records in each key table.
    ```sql
    SELECT 'Users' AS table_name, COUNT(*) FROM app_user UNION ALL
    SELECT 'Roles', COUNT(*) FROM app_role UNION ALL
    SELECT 'ClientProfiles', COUNT(*) FROM app_clientprofile UNION ALL
    SELECT 'Processes', COUNT(*) FROM app_process UNION ALL
    SELECT 'Equipment', COUNT(*) FROM app_equipment UNION ALL
    SELECT 'Reports', COUNT(*) FROM app_report UNION ALL
    SELECT 'Anotaciones', COUNT(*) FROM app_anotacion UNION ALL
    SELECT 'ProcessStatusLogs', COUNT(*) FROM app_processstatuslog;
    ```
