{% extends "base.html" %}
{% load static %} {# Necesario para íconos si los usas localmente, o usa CDN de FontAwesome #}

{% block title %}Dashboard del Cliente{% endblock %}

{% block extra_css %}
<style>
    body {
        background-color: #f8f9fa; /* Un fondo claro para la página */
    }
    .sidebar {
        background-color: #343a40; /* Color oscuro para la barra lateral */
        color: white;
        padding: 20px;
        min-height: calc(100vh - 56px); /* Altura completa menos la altura del navbar si tienes uno fijo */
        position: fixed; /* Fija la barra lateral */
        top: 56px; /* Ajusta esto si tu navbar tiene altura diferente o no es fijo */
        left: 0;
        width: 250px; /* Ancho de la barra lateral */
        z-index: 100;
    }
    .sidebar a {
        color: rgba(255, 255, 255, 0.8);
        display: block;
        padding: 10px 15px;
        text-decoration: none;
        border-radius: 0.25rem;
    }
    .sidebar a:hover, .sidebar a.active {
        background-color: #495057;
        color: white;
    }
    .main-content {
        margin-left: 250px; /* Mismo ancho que la barra lateral para dejar espacio */
        padding: 20px;
        background-color: #ffffff; /* Fondo blanco para el contenido principal */
        min-height: calc(100vh - 56px);
    }
    .content-header {
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 1px solid #dee2e6;
    }
    .card-custom {
        border: none;
        box-shadow: 0 0.125rem 0.25rem rgba(0,0,0,.075);
    }
    .welcome-section, .notifications-section {
        padding: 20px;
        background-color: #e9ecef;
        border-radius: 0.5rem;
        margin-bottom: 20px;
    }
</style>
{% endblock %}

{% block content %}
<div class="d-flex">
    <!-- Barra Lateral de Navegación de Procesos -->
    <nav class="sidebar">
        <h5 class="mb-3">Tipos de Proceso</h5>
        <ul class="nav flex-column">
            <li class="nav-item mt-3">
                <a class="nav-link {% if not proceso_activo %}active{% endif %}" href="{% url 'home' %}">
                    <i class="fas fa-home me-2"></i> Inicio / Notificaciones
                </a>
            </li>
            {% for value, label in process_types_choices %}
            <li class="nav-item">
                <a class="nav-link {% if proceso_activo == value %}active{% endif %}" href="{% url 'home' %}?proceso_activo={{ value }}">
                    {{ label }}
                </a>
            </li>
            {% endfor %}
        </ul>
    </nav>

    <!-- Contenido Principal -->
    <main class="main-content">
        <div class="container-fluid">
            {% if not proceso_activo %}
                <!-- Estado Inicial: Bienvenida y Notificaciones -->
                <div class="welcome-section text-center">
                    <h1 class="display-5">{{ titulo }}</h1>
                    <p class="lead">{{ mensaje_bienvenida }}</p>
                </div>

                {% if equipos_licencia_por_vencer %}
                <div class="notifications-section mt-4">
                    <h4 class="mb-3"><i class="fas fa-bell me-2"></i>Notificaciones: Licencias Próximas a Vencer</h4>
                    <div class="table-responsive">
                        <table class="table table-hover table-sm">
                            <thead class="table-light">
                                <tr>
                                    <th>Nombre</th>
                                    <th>Marca</th>
                                    <th>Modelo</th>
                                    <th>Serial</th>
                                    <th>Fecha Vencimiento</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for equipo in equipos_licencia_por_vencer %}
                                <tr>
                                    <td>{{ equipo.nombre }}</td>
                                    <td>{{ equipo.marca|default:"-" }}</td>
                                    <td>{{ equipo.modelo|default:"-" }}</td>
                                    <td>{{ equipo.serial|default:"-" }}</td>
                                    <td>{{ equipo.fecha_vigencia_licencia|date:"d/m/Y" }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
                {% else %}
                <div class="notifications-section mt-4 text-center">
                     <h4 class="mb-3"><i class="fas fa-bell me-2"></i>Notificaciones</h4>
                    <p>¡Felicidades, no hay equipos con licencias próximas a vencer!</p>
                </div>
                {% endif %}

            {% else %}
                <!-- Estado con Proceso Seleccionado -->
                <div class="content-header">
                    <h2>
                        {% for value, label in process_types_choices %}
                            {% if proceso_activo == value %}{{ label }}{% endif %}
                        {% endfor %}
                    </h2>
                </div>

                <div class="row">
                    <!-- Columna de Equipos Asociados -->
                    <div class="col-md-6">
                        <div class="card card-custom mb-4">
                            <div class="card-header bg-light">
                                <h5 class="mb-0"><i class="fas fa-tools me-2"></i>Equipos Asociados</h5>
                            </div>
                            <div class="card-body">
                                {% if equipos %}
                                <div class="table-responsive">
                                    <table class="table table-striped table-sm">
                                        <thead>
                                            <tr>
                                                <th>Nombre</th>
                                                <th>Serial</th>
                                                <th>Fecha Inicio Proceso</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for equipo in equipos %}
                                            <tr>
                                                <td><a href="{% url 'equipos_detail' equipo.id %}">{{ equipo.nombre }}</a></td>
                                                <td>{{ equipo.serial|default:"N/A" }}</td>
                                                <td>{{ equipo.process.fecha_inicio|date:"d/m/Y" }}</td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                                <div class="text-center mt-3">
                                     <a href="{% url 'equipos_list' %}?process_type={{ proceso_activo }}" class="btn btn-sm btn-outline-primary">Ver todos los equipos de este tipo</a>
                                </div>
                                {% else %}
                                <p class="text-muted">No hay equipos asociados a este tipo de proceso.</p>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <!-- Columna de Reportes Asociados -->
                    <div class="col-md-6">
                        <div class="card card-custom mb-4">
                            <div class="card-header bg-light">
                                <h5 class="mb-0"><i class="fas fa-file-alt me-2"></i>Reportes Asociados</h5>
                            </div>
                            <div class="card-body">
                                {% if reportes %}
                                <div class="table-responsive">
                                    <table class="table table-striped table-sm">
                                        <thead>
                                            <tr>
                                                <th>Título</th>
                                                <th>Fecha Creación</th>
                                                <th>PDF</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for reporte in reportes %}
                                            <tr>
                                                <td><a href="{% url 'report_detail' reporte.id %}">{{ reporte.title }}</a></td>
                                                <td>{{ reporte.created_at|date:"d/m/Y" }}</td>
                                                <td>
                                                    {% if reporte.pdf_file %}
                                                    <a href="{{ reporte.pdf_file.url }}" target="_blank" class="btn btn-sm btn-outline-danger">
                                                        <i class="fas fa-file-pdf"></i>
                                                    </a>
                                                    {% else %}
                                                    N/A
                                                    {% endif %}
                                                </td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                                 <div class="text-center mt-3">
                                     <a href="{% url 'report_list' %}?process_type={{ proceso_activo }}" class="btn btn-sm btn-outline-success">Ver todos los reportes de este tipo</a>
                                </div>
                                {% else %}
                                <p class="text-muted">No hay reportes asociados a este tipo de proceso.</p>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            {% endif %}
        </div>
    </main>
</div>
{% endblock %}
